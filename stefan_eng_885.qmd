---
title: "885 Project"
author: "Stefan Eng"
date: "`r Sys.Date()`"
engine: knitr
bibliography: Project-Varying-coefs.bib
execute:
  echo: false
  message: false
  warning: false
format:
  pdf:
    fig-pos: 'h'
    documentclass: article
    fontsize: 12pt
    geometry:
      - margin=1in
    template-partials:
      - tex_partials/title.tex
      - tex_partials/before-body.tex
include-in-header:
  text: |
    \usepackage{setspace}
    \usepackage{lipsum}
    \doublespacing
    \linespread{2} % Ensures 25 lines per page
    \setlength{\parindent}{0pt}
    \setlength{\parskip}{1em}
abstract: |
  This is the abstract.
---

```{r}
#| echo: false
#| message: false
#| warning: false
library(mgcv)
library(ggplot2)
library(gratia)
library(survival)
library(survminer)
library(ggsurvfit)
library(scales)
library(dplyr)
library(broom)
data(heart)
heart2 <- read.table("Heart_data.txt", skip = 18, header = TRUE)
heart2$reject <- as.factor(heart2$reject)
heart2$surgery <- as.factor(heart2$surgery)
heart2$transplant <- as.factor(heart2$transplant)
heart2$survived <- as.factor(heart2$fustat == 0)
heart$transplant_fct <- as.factor(heart$transplant)
heart2$transplant_fct <- as.factor(heart2$transplant)
heart2$event <- heart2$fustat
levels(heart$transplant_fct) <- c("No transplant", "Transplant")

rm(heart)
heart <- heart2
# Note: It looks like the heart dataset from class is the same cases but heart in survival
# adds controls

# TODO: Swap out for heart with more subjects
#heart$futime <- heart$stop - heart$start
#heart$age <- heart$age + 48

colortheme2 <- c("#FDB44E", "skyblue")
theme_set(theme_minimal())
```

## Introduction

Heart transplantation is a critical intervention for patients with end-stage heart failure, offering a potential extension of life and potential for improved quality of life.
The decision for a doctor to advise a patient to undergo a heart transplant is a complex one as it may negatively influence patient survival as well.
This is influenced by various factors, including patient age and clinical status.
Understanding the impact of heart transplantation on patient survival is essential for optimizing treatment strategies and resource allocation.

The Stanford Heart Transplant dataset (Cite: Crawford 77) provides a valuable resource for studying survival outcomes in patients awaiting or undergoing heart transplantation.
This dataset has been analyzed extensively in the literature, with researchers using it to develop and validate survival models, including Cox proportional hazards models.
Derived from a cohort at Stanford University, this dataset includes detailed time-to-event data, allowing for a nuanced analysis of survival probabilities, the effects of treatment, and the role of patient characteristics over time.

In this study we use the original 103 patient Stanford Heart Transplant dataset to investigate the survival effects of heart transplantation while accounting for patient age and time-dependent factors.
This study has a follow up 173 patients that adds on additional controls.
We use this extension for the Cox proportional hazards model to ensure that we have sufficient patients for each combination of transplant and bypass surgery status.
Our investigation is largely an exploratory analysis which could form the basis for future research on heart transplantation survival.
Specifically, we explored the non-linear interaction between age and transplant for survival outcomes for both logistic and survival models using varying-coefficient models.
Varying-coefficient models are a flexible class of models that allow for the estimation of non-linear relationships between covariates and outcomes [@hastie1993].
We will use both local linear kernel methods and smoothing splines [@wood2011] to model the time-varying coefficient model for binary survival outcome ane time-to-event data.

## Results

There are a total of `r sum(heart$fustat == 0)` deaths and `r sum(heart$fustat == 1)` censored/survival observations in the dataset (`r label_percent()(mean(heart$fustat))`).
See @tbl-1 in the appendix for a summary of the dataset.
In @fig-age-transplant-interaction, we observe a potential non-linear interaction between age and both transplant status and previous bypass surgery on follow-up time.
Those that survived and did received a transplant appear to have a different relationship between age and follow-up time compared to those that did not receive a transplant.
The univariate smooth spline fit only indicates a quadratic relationship in which follow-up time is increased for median age patients for the survived and transplant group.
There is visually a similar pattern for those patients that died and received transplant but the penalized smoothing spline fit is essentially flat.
We see a similar pattern for the interaction between age and bypass surgery on follow-up time in @fig-age-surgery-interaction.
We also explored the relationship between age and follow-up time for those that received a transplant by pre-transplant bypass surgery status but did not observe any clear patterns See @fig-surgery-transplant-interaction in the appendix.
These results are consistent with the original work done in [@crowley1977] in which they did a stratified analysis on age groups $[8,40), [40,50), [50,65)$ which suggested a quadratic effect of age though this was not statistically significant.


```{r}
#| label: fig-age-transplant-interaction
#| fig-height: 4
#| fig-width: 7
#| fig-cap: "Interaction between age and transplant status on follow-up time"
ggplot(heart2, aes(x = age, y = futime)) +
  facet_grid(rows = vars(transplant),
             cols = vars(survived),
             labeller = labeller(
               survived = function(x) ifelse(x, "Survived", "Died"),
               transplant = function(x) ifelse(x == 1, "Transplant", "No Transplant")
            )) +
  geom_point() +
  geom_smooth(method = "gam", formula = y ~ s(x, bs = "bs")) +
  theme_classic() +
  ylab("Follow-up time") +
  xlab("Age") +
  coord_cartesian(ylim = c(0, max(heart2$futime) + 10))
```

```{r}
#| label: fig-age-surgery-interaction
#| fig-height: 4
#| fig-width: 7
#| fig-cap: "Interaction between age and bypass surgery on follow-up time"
ggplot(heart2, aes(x = age, y = futime)) +
  facet_grid(rows = vars(surgery),
             cols = vars(survived),
             labeller = labeller(
               survived = function(x) ifelse(x, "Survived", "Died"),
               surgery = function(x) ifelse(x == 1, "Bypass Surgery", "No bypass")
            )) +
  geom_point() +
  geom_smooth(method = "gam", formula = y ~ s(x, bs = "bs")) +
  theme_classic() +
  ylab("Follow-up time") +
  xlab("Age") +
  coord_cartesian(ylim = c(0, max(heart2$futime) + 10))
```

### Logistic regression age-varying models

We fit a logistic regression model to the binary outcome of survival to investigate the relationship between age, transplant status, and survival.
From the exploratory analysis, we fit four generalized linear additive models models:

1. Three-way interaction between bypass surgery, transplant, and age with no smooth terms
2. Smooth age-varying interaction between bypass surgery and age
3. Separate smooth age-varying interactions between transplant and bypass surgery
4. Smooth age-varying term for bypass surgery-transplant interaction.

We note that the sample size for the dataset is small and the models are more exploratory in nature as the power is quite low.
We compare the models using the Akaike Information Criterion (AIC) and deviance in @tbl-logit-aic-table in the appendix.
The linear generalized model with no smooth terms and the smooth age-varying interaction between bypass surgery and age have similar AIC and deviance values.
The best model selected by AIC has a smooth age-varying interaction between bypass surgery and a constant term for transplant status.
In @fig-gam-spline-glm, we plot the predicted survival probabilities from the best model along the range of ages for patients with and without bypass surgery and transplant status.
The model has an age-varying coefficient for bypass surgery which has substantial non-linear components (empirical degrees of freedom = 3.8, p = 0.0167) for the non-surgery group.
The bypass surgery age-varying term is approximately linear (edf = 1.04, p-value = 0.187).
The odds transplant fixed effect has an odds ratio of 0.20 (95% CI: 0.05, 0.75), which indicates a 5 times lower odds of survival for those that received a transplant.
The odds ratio of the intercept term for prior bypass is 0.33 (95% CI: 0.083, 1.30).
Since we have an age-varying coefficient for bypass surgery, the odds ratio for bypass surgery is not interpretable in the usual sense and we need to consider the interaction with age.
For those that received bypass surgery, the survival probability appears lower than those that did not receive bypass surgery but the confidence intervals are quite wide as there are few patients far away from the median age.
We include the individual centered partial effects in @fig-gam-spline-partial in the appendix.
See 
TODO: Quantify this difference?

```{r}
#| label: fig-gam-spline-glm
#| fig-height: 4
#| fig-width: 8
#| fig-cap: "Predicted survival probabilities from GAM with smooth age-varying between bypass term. We predict the survival time subset by transplant status and bypass surgery status along the range of ages. The shaded area represents the 95% Bayesian credible intervals."

source("gam_model_glm.R")

# tidy(final_gam_model_logit$reml, conf.int = T, parametric = T, exponentiate = T)
# Get confidence interval for transplant

k <- 100
pred_data_logit <- expand.grid(
  age = seq(min(heart$age) + 1, max(heart$age) - 1, length.out = 100),
  transplant = c(0,1),
  surgery = c(0,1))

pred_data_logit$transplant <- as.factor(pred_data_logit$transplant)
pred_data_logit$surgery <- as.factor(pred_data_logit$surgery)

gam_preds_logit <- predict(
  final_gam_model_logit$reml,
  newdata = data.frame(pred_data_logit), se.fit = TRUE, type = "response")

plot_data_logit <- cbind(
  pred_data_logit,
  fit = 1 - gam_preds_logit$fit,
  lower_ci = (1 - gam_preds_logit$fit) - 1.96 * gam_preds_logit$se.fit,
  upper_ci = (1 - gam_preds_logit$fit) + 1.96 * gam_preds_logit$se.fit)


factor_levels <- c("No transplant", "Transplant")
  
ggplot(plot_data_logit) +
  facet_grid(
    ~ surgery,
    labeller = labeller(
      surgery = function(x) ifelse(x == 1, "Bypass Surgery", "No bypass")
  )
) +
  geom_line(
    aes(x = age, y = fit,
        color = as.factor(transplant)
          )) +
  geom_ribbon(aes(x = age, ymin = lower_ci, ymax = upper_ci, fill = as.factor(transplant),
          ), alpha = 0.2) +
  theme_classic() +
  scale_color_manual(
    name = "",
    labels = factor_levels,
    values = colortheme2
  ) +
  scale_fill_manual(
    name = "",
    labels = factor_levels,
    values = colortheme2
    ) +
  labs(title = "Predicted survival probabilities from GAM logistic regression",
       x = "Age", y = "Survival probability") +
  coord_cartesian(ylim = c(0, 1)) +
  scale_y_continuous(breaks = c(0, 0.5, 1))
```

### Cox Proportional Hazard Age-Varying Models

We fit a Cox proportional hazards models to the time-to-event data to investigate the relationship between age, transplant status, and survival.
For these models we used the extended heart transplant dataset with 172 patients.
This adds on additional controls such that there are sufficient patients for each combination of transplant and bypass surgery status.
Based on exploratory analysis, we fit three models

1. A linear model with three-way interaction between bypass surgery, transplant, and age.
2. A model with a smooth age-varying bypass surgery effect.
3. A model with a smooth age-varying transplant effect.
4. A model with both transplant and bypass surgery age-varying effect.

In this case we found that the best model was the age-varying transplant effect model.
(See @tbl-logit-aic-table in appendix.)
To assess how the model fits the data we predict the survival time subset by transplant status and bypass surgery status with three ages 39.7, 47.8, 53.0 which correspond to quantiles of 20%, 50% and 80% as shown in @fig-gam-survival-surgery.


```{r}
#| label: fig-gam-survival-surgery
#| fig-height: 6
#| fig-width: 8
#| fig-cap: "Predicted survival probabilities from generalized additive age-varying Cox proportional hazard model. The model includes age-varying coefficient for bypass surgery and intercepts for transplant status. We predict the survival time subset by transplant status and bypass surgery status with three ages 39.7, 47.8, 53.0 which correspond to quantiles of 20%, 50% and 80%. The shaded area represents the 95% Bayesian credible intervals."

source("gam_model_cox.R")

k <- 100
pred_data <- expand.grid(
  futime = seq(0, max(heart2$futime), length.out = k),
  age = quantile(heart2$age, probs = c(0.2, 0.5, 0.8)),
  transplant = c(0,1),
  surgery = c(0,1))

levels(pred_data$transplant) <- c("No transplant", "Transplant")

gam_preds <- predict(
  final_gam_model_cox$reml,
  newdata = data.frame(pred_data), se.fit = TRUE, type = "response")

plot_data <- cbind(
  pred_data,
  fit = gam_preds$fit,
  lower_ci = gam_preds$fit - 1.96 * gam_preds$se.fit,
  upper_ci = gam_preds$fit + 1.96 * gam_preds$se.fit)

factor_levels <- c("No transplant", "Transplant")
  
ggplot(plot_data) +
  facet_grid(
    as.factor(age) ~ surgery,
    labeller = labeller(
      `as.factor(age)` = function(x) paste("Age:", round(as.numeric(x), 2)),
      surgery = function(x) ifelse(x == 1, "Bypass Surgery", "No bypass")
  )) +
  geom_line(
    aes(x = futime, y = fit,
        color = as.factor(transplant)
          )) +
  geom_ribbon(aes(x = futime, ymin = lower_ci, ymax = upper_ci, fill = as.factor(transplant),
          ), alpha = 0.2) +
  theme_classic() +
  scale_linetype_manual(
    values = c(1, 2),
    name = "Surgery",
    labels = c("No bypass", "Bypass Surgery")
  ) +
  scale_color_manual(
    name = "",
    labels = factor_levels,
    values = colortheme2
    ) +
  scale_fill_manual(
    name = "",
    labels = factor_levels,
    values = colortheme2
    ) +
  labs(title = "Predicted survival probabilities from GAM",
       x = "Time", y = "Survival probability") +
  coord_cartesian(ylim = c(0, 1)) +
  scale_y_continuous(breaks = c(0, 0.5, 1))
```


## Methods

### Varying coefficients via smoothing splines

We fit local linear logistic regression models for the binary outcome of survival as well a Cox proportional hazards model for time-to-event data.
Let $\mu_i$ be the probability that patient $i$ survives.
We model the log-odds of survival as a function of patient age and transplant status using a logistic regression varying-coefficient model:

$$
\begin{aligned}
\text{logit}(\mu_i) &= \beta_0 + \beta_1 \cdot \text{surgery}_i + \beta_2 \cdot \text{transplant}_i + \beta_3 \cdot \text{age}_i + \beta_4 \cdot (\text{surgery}_i \cdot \text{transplant}_i)\\
    &\quad\quad +  \beta_5 \cdot (\text{surgery}_i \cdot \text{age}_i) + \beta_6 \cdot (\text{transplant}_i \cdot \text{age}_i) + \beta_7 \cdot (\text{surgery}_i \cdot \text{transplant}_i \cdot \text{age}_i)\\
\text{logit}(\mu_i) &= \beta_0 + \beta_1 \cdot \text{surgery}_i + \beta_2 \cdot \text{transplant}_i + \theta_{\text{surgery}}(\text{age}_i)\cdot \text{surgery}_i \\
\text{logit}(\mu_i) &= \beta_0 + \beta_1 \cdot \text{surgery}_i + \beta_2 \cdot \text{transplant}_i + \theta_{\text{transplant}}(\text{age}_i)\cdot \text{transplant}_i \\
\text{logit}(\mu_i) &= \beta_0 + \beta_1 \cdot \text{surgery}_i + \beta_2 \cdot \text{transplant}_i +  \beta_3 \text{surgery}_i \cdot \text{transplant}_i\\
&\quad\quad+ \theta_{\text{surgery}}(\text{age}_i)\cdot \text{surgery}_i +  \theta_{\text{transplant}}(\text{age}_i) \cdot \text{transplant}_i
\end{aligned}
$$

where $\theta_1(x)$ and $\theta_2(x)$ are smoothing splines of age for patients.
We include treatment as a fixed effect as smoothing splines are centered so we need to include an intercept to retain the correct interpretation of the treatment effect.
For the censored time-to-event data, we fit one linear Cox proportional hazards models, and two with varying-age smoothing spline coefficients for treatment and surgery.

$$
\begin{aligned}
\lambda_{linear}(t_i \mid X) &= \lambda_0(t_i) \exp\{ \beta_0 + \beta_1 \cdot \text{surgery}_i + \beta_2 \cdot \text{transplant}_i + \beta_3 \cdot \text{age}_i + \beta_4 \cdot (\text{surgery}_i \cdot \text{transplant}_i) \\
    &\quad\quad\quad +  \beta_5 \cdot (\text{surgery}_i \cdot \text{age}_i) + \beta_6 \cdot (\text{transplant}_i \cdot \text{age}_i) + \beta_7 \cdot (\text{surgery}_i \cdot \text{transplant}_i \cdot \text{age}_i) \} \\
\lambda_{1}(t_i \mid X) &= \lambda_0(t_i) \exp\{
  \beta_0 + \beta_1 \cdot \text{surgery}_i + \beta_2 \cdot \text{transplant}_i +         \theta_{\text{surgery}}(\text{age}_i)\cdot \text{surgery}_i\} \\
\lambda_{2}(t_i \mid X) &= \lambda_0(t_i) \exp\{
  \beta_0 + \beta_1 \cdot \text{surgery}_i + \beta_2 \cdot \text{transplant}_i +     \theta_{\text{transplant}}(\text{age}_i)\cdot \text{transplant}_i \} \\
\lambda_{3}(t_i \mid X) &= \lambda_0(t_i) \exp\{
  \beta_0 + \beta_1 \cdot \text{surgery}_i + \beta_2 \cdot \text{transplant}_i +  \beta_3 \text{surgery}_i \cdot \text{transplant}_i\\
&\quad\quad\quad\quad + \theta_{\text{surgery}}(\text{age}_i)\cdot \text{surgery}_i +  \theta_{\text{transplant}}(\text{age}_i) \cdot \text{transplant}_i \}
\end{aligned}
$$

All smoothing spline models were fit using B-splines with the mgcv [@wood2011] package in R.

### Local linear kernel smoothing for age-varying treament

We also fit a local linear logistic regression model for the binary outcome of survival using a kernel smoothing approach.
Our setup is similar to the varying coefficient model but we use a kernel function to weight the contribution of each patient to the local linear fit.

$$
\begin{aligned}
g(\mu_i) &= \theta_1(\text{age}_i) + \theta_2(\text{age}_i) TRT_i
\end{aligned}
$$

We use a local linear approximations $\theta_1(x) = \alpha_{11} + \alpha_{12} x$ and $\theta_2(x) = \alpha_{21} + \alpha_{22} x$ and solve the estimating equation

TODO: Fix this, should be on the logit scale
$$
\sum_{i=1}^n K_h(\text{age}_i - x) \left[ Y_i - \theta_1(x) - \theta_2(x) T_i \right] = 0
$$

where $K_h$ is a kernel function with bandwidth $h$.
TODO: Which kernel function did we use?

## Discussion

## References

::: {#refs}
:::

## Appendix

```{r table1}
#| label: tbl-1
#| tbl-cap: "Cohort characteristics of the 103 Stanford Heart Transplant dataset"
library(table1)
heart2$survival <- as.factor(heart2$fustat == 0)
levels(heart2$survival) <- c("Died", "Survived/Censored")
table1(~ futime + age + surgery + transplant + mscore + reject + wait.time + mismatch + hla.a2 | survival, data = heart2)
```

### Logistic Regression models

```{r}
#| label: fig-gam-spline-partial
#| fig-height: 4
#| fig-width: 8
#| fig-cap: "Partial centered B-spline effects for logistic regression model."

gratia::draw(final_gam_model_logit$reml, scales = "fixed")
```

### Cox proportional hazards models

```{r tbl-coxph-aic-table}
#| label: tbl-coxph-aic-table
#| tbl-cap: "AIC and deviance for Cox proportional hazards GAM models"
kableExtra::kable(
  cbind(model = c("linear", "age-surgery smooth", "age-transplant smooth",
                  "age-transplant and age-surgery smooths"), gam_table_aic[, c('aic', 'deviance')]), digits = 1) %>%
  # bold the best model
  kableExtra::row_spec(row = which.min(gam_table_aic$aic), bold = TRUE)
```

```{r tbl-logit-aic-table}
#| label: tbl-logit-aic-table
#| tbl-cap: "AIC and deviance for logistic regression GAM models"
kableExtra::kable(
  cbind(model = c("linear", "age-surgery smooth", "age-transplant smooth",
                  "age-transplant and age-surgery smooths"), gam_table_aic_logit[, c('aic', 'deviance')]), digits = 1) %>%
  # bold the best model
  kableExtra::row_spec(row = which.min(gam_table_aic_logit$aic), bold = TRUE)
```

```{r}
#| label: fig-surgery-transplant-interaction
#| fig-height: 5
#| fig-width: 8
#| fig-cap: "TODO"

heart2 %>% 
  filter(transplant == 1) %>%
ggplot(., aes(x = age, y = futime)) +
  facet_grid(rows = vars(surgery),
             cols = vars(survived),
             labeller = label_both) +
  geom_point() +
  geom_smooth(method = "gam", formula = y ~ s(x, bs = "bs")) +
  theme_minimal() +
  ylab("Follow-up time") +
  xlab("Age") +
  ylim(c(0, max(heart2$futime) + 10))
```

### Exploratory plots

#### Heatmap of correlation matrix
```{r}
#| label: fig-corr-heatmap
#| fig-height: 5
#| fig-width: 8
#| fig-cap: "..."
numeric_heart2 <- heart2[sapply(heart2, is.numeric) & ! names(heart2) %in% "fustat"]
spearman_cor <- cor(numeric_heart2, method = "spearman", use = "pairwise.complete.obs")
corrplot::corrplot(
  spearman_cor, diag = F, type = "upper",
  method = "number",
  order = "hclust", is.corr = TRUE,
  )
```
